openapi: 3.0.1
info:
  title: Insurance App API
  description: API for uploading policy data, searching policies, and aggregation
  version: 1.0.0
servers:
  - url: http://localhost:3000
    description: Local server

paths:
  /api/policies/aggregated:
    get:
      summary: Get aggregated policies grouped by user
      responses:
        '200':
          description: Aggregated policy data
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/AggregatedPolicy'
        '500':
          description: Aggregation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/policies/search:
    get:
      summary: Search policies by username
      parameters:
        - name: username
          in: query
          description: Search term for user's first name
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Matching policies
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/PolicySummary'
        '400':
          description: Username is required
        '404':
          description: No user found
        '500':
          description: Search failed

  /api/upload:
    post:
      summary: Upload spreadsheet or CSV file
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: File to upload (.xlsx, .xls, .csv)
      responses:
        '200':
          description: File processed successfully
        '400':
          description: Bad request
        '500':
          description: Server error

  /api/upload/local:
    post:
      summary: Upload using local file path
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                filePath:
                  type: string
                  example: C:\\path\\to\\file.xlsx
      responses:
        '200':
          description: File processed successfully
        '400':
          description: Bad request
        '500':
          description: Server error

components:
  schemas:
    AggregatedPolicy:
      type: object
      properties:
        userId:
          type: string
        userName:
          type: string
        userEmail:
          type: string
        totalPolicies:
          type: integer
        policies:
          type: array
          items:
            type: object
            properties:
              policyNumber:
                type: string
              startDate:
                type: string
              endDate:
                type: string
              category:
                type: string
              carrier:
                type: string
        categories:
          type: array
          items:
            type: string
        carriers:
          type: array
          items:
            type: string

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
        error:
          type: string

    PolicySummary:
      type: object
      properties:
        _id:
          type: string
        policyNumber:
          type: string
        policyStartDate:
          type: string
        policyEndDate:
          type: string
        userId:
          $ref: '#/components/schemas/UserSummary'
        categoryId:
          type: object
          properties:
            categoryName:
              type: string
        companyId:
          type: object
          properties:
            companyName:
              type: string

    UploadResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
        data:
          type: object

    UserSummary:
      type: object
      properties:
        _id:
          type: string
        firstName:
          type: string
        email:
          type: string
        phone:
          type: string